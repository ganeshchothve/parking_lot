// TODO: handle case if sell.do throws error, the form is hidden and nothing will happen
<% url = Rails.application.routes.url_helpers %>
var OtpBasedLogin = (function(){
  var handleSendOtpSuccess = function(elem, data, resend){
    if (resend != undefined && resend) {
      Amura.global_success_handler('<%= I18n.t("sessions.notice.otp_sent_to") %>' + data.phone);
    }
    $('.top-message').html('<%= I18n.t("sessions.notice.otp_sent_to") %>' + data.phone).closest('.top-notification').removeAttr('hidden');
    $(elem).find('[name="user[login]"]').closest(".mb-3").attr("hidden", "hidden");
    $(elem).find('[name="user[login_otp]"]').closest(".mb-3").removeAttr("hidden");
    $(elem).find('[name="user[login_otp]"]').focus();
    $(elem).find('.resend-otp').parent().removeClass("d-none");
    $(elem).find('.resend-otp').attr("disabled", "disabled");
    $(elem).removeAttr("data-type").removeAttr("data-remote");
    setTimeout(function(){
      if(data.confirmed){
        $(elem).find('input[type="submit"]').val('<%= I18n.t("devise.keys.log_in") %>').attr("data-disable-with", '<%= I18n.t("devise.keys.logging_in") %>');
      }else{
        $(elem).find('input[type="submit"]').val('<%= I18n.t("devise.keys.verify_your_account") %>').attr("data-disable-with", '<%= I18n.t("devise.keys.verifying_login") %>');
      }
    }, 200);

    setTimeout(function(){
      $(elem).find('.resend-otp').removeAttr("disabled");
    },15000);

    $(elem).attr("action", "<%= url.user_session_path %>");
  };

  var handleSendOtpError = function(xhr, data){
    if(xhr.status == 201){
      Amura.global_error_handler('Invalid Phone Number');
    }else if(xhr.status == 422){
      Amura.global_error_handler(data['errors']);
    }
  }

  var init = function(){
    FormInitializer.init($("#standard_login_form"));
    FormInitializer.init($("#otp_user_form"));

    $(".toggle_signin_form").click(function(e){
      var target = $(e.currentTarget).data("target");
      $("section").addClass("d-none");
      $(target).removeClass("d-none");
    })

    $(document).on("ajax:success", '#otp_user_form', function(evt){
      var detail = evt.detail;
      var data = detail[0], status = detail[1], xhr = detail[2];
      handleSendOtpSuccess($(this), data);
    });

    $(document).on("ajax:error", '#otp_user_form', function(evt){
      var detail = evt.detail;
      var data = detail[0], status = detail[1], xhr = detail[2];
      handleSendOtpError(xhr, data);
    });
    $('#otp_user_form .resend-otp').click(function(e){
      $.ajax({
        url: "/users/otp",
        data: $('#otp_user_form').serializeArray(),
        dataType: "json",
        type: "post",
        success: function(data, status, xhr){
          handleSendOtpSuccess($('#otp_user_form'), data, true);
        },
        error: function(xhr, status, data){
          handleSendOtpError(xhr, xhr.responseJSON);
        }
      })
    })
  };

  return {
    init: init
  }
})();
