<% if current_client.enable_actual_inventory?(current_user) %>
  <div class="card box-card mb-3 border-0">
    <a data-toggle="collapse" href="#dashboard_project_units" role="button" aria-expanded="false" aria-controls="dashboard_project_units" class='font-weight-bold text-decoration-none'>
      <div class="card-header box-header border-0">
        <h2 class="text-dark">
          <%= image_tag "building-black.svg", alt: "Units" %>
          <%= ProjectUnit.model_name.human(count: 3) %>
        </h2>
        <%= link_to 'View All', admin_project_units_path, class: 'view-all-btn' %>
      </div>
    </a>
    <div class="card-body collapse box-content br-rd-bl-4 bg-white p-0" id="dashboard_project_units">
      <div class="mt-2">
        <%= form_tag dashboard_path, method: "get", id: "dashboard-project_units-fltrs" do %>
          <div class="row">
            <div class="col-md-11">
              <div class="mb-3">
                <%= select_tag "unit_fltrs[group_by]", options_for_select(DashboardDataProvider.project_units_available_group_by.collect{|x| [x[:text], x[:id]]}, (params[:unit_fltrs].present? && params[:unit_fltrs][:group_by].present? ? params[:unit_fltrs][:group_by] : [])), {class: "selectize", prompt: I18n.t("global.select"), multiple: true} %>
              </div>
            </div>
            <div class="col-md-1">
              <div class="mb-3">
                <%= submit_tag I18n.t("global.apply"), class: "btn btn-primary float-md-right" %>
              </div>
            </div>
          </div>
        <% end %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr class="bg-primary white">
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("project_tower_id")) || params[:unit_fltrs].nil? %>
                <th>Tower</th>
                <% end %>
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("bedrooms")) || params[:unit_fltrs].nil? %>
                <th>Bedrooms</th>
                <% end %>
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("status")) || params[:unit_fltrs].nil? %>
                <th>Status</th>
                <% end %>
                <th class="text-right">Count</th>
                <th class="text-right">Total Agreement Price</th>
                <th class="text-right">Total All Inclusive Price</th>
                <th class="text-right"><%= I18n.t("global.actions") %></th>
              </tr>
            </thead>
            <tbody>
              <% DashboardDataProvider.project_units_dashboard(current_user, params[:unit_fltrs]).sort{|x, y | [x[:project_tower_name], x[:bedrooms], x[:status]] <=> [y[:project_tower_name], y[:bedrooms], y[:status]]}.each do |d| %>
              <tr>
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("project_tower_id")) || params[:unit_fltrs].nil? %>
                <td><%= d[:project_tower_name] %></td>
                <% end %>
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("bedrooms")) || params[:unit_fltrs].nil? %>
                <td><%= d[:bedrooms] %></td>
                <% end %>
                <% if (params[:unit_fltrs] && params[:unit_fltrs][:group_by] && params[:unit_fltrs][:group_by].include?("status")) || params[:unit_fltrs].nil? %>
                <td><%= t("mongoid.attributes.project_unit/status.#{d[:status]}") %></td>
                <% end %>
                <td class="text-right"><%= d[:count] %></td>
                <td class="text-right"><%= number_to_indian_currency(d[:total_agreement_price]) %></td>
                <td class="text-right"><%= number_to_indian_currency(d[:total_all_inclusive_price]) %></td>
                <td class="text-right">
                  <% if policy([:admin, ProjectUnit]).index? %>
                    <%= link_to "View", admin_project_units_path(fltrs: {status: d[:status], project_tower_id: d[:project_tower_id], bedrooms: d[:bedrooms]}), target: "_blank" %>
                  <% end %>
                </td>
              </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% end %>
<%= javascript_tag do %>
  $(document).ready(function(){
    FormInitializer.init($("#dashboard-project_units-fltrs"));
  });
<% end %>
