<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-12">
      <div class="row">
        <div class="col-md-4">
          <div class="card card-body h-100 text-center bg-primary text-white">
            To be fair to other user interested in this apartment, we have held this unit for some time. Please go through the costs & payment schedule before you make a payment of <%= number_to_indian_currency(current_client.blocking_amount) %>.<br/>
            <div class="font-weight-bold jquery-countdown-container" id="held-until-countdown"></div>
          </div>
        </div>
        <div class="col-md-8 mt-3 mt-md-0">
          <%= render 'dashboard/booking_detail_overview', {booking_detail: @booking_detail} %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <%= nested_form_for([ current_user_role_group, @booking_detail, @booking_detail_scheme], local: true, html: {class: 'modal-remote-form validate-form', "data-resource-type": global_labels['schemes'], "data-type": "json", id: 'scheme_form'}) do |f| %>
        <%= render 'booking_detail_schemes/form', booking_detail_scheme: @booking_detail_scheme, booking_detail: @booking_detail, f: f %>
        <%= f.submit "Apply", class: "btn btn-primary" %>
      <% end %>
    </div>
    <div class="col-md-8">
      <div class="mt-3"></div>
      <%= render 'dashboard/booking_detail_cost_sheet', booking_detail: @booking_detail  %>
      <div class="mt-3"></div>
      <%= render "dashboard/project_unit_payment_schedule", booking_detail: @booking_detail, search: @search %>
      <div class="mt-3"></div>
      <%
        alert = (current_client.cancellation_amount.present? && current_client.cancellation_amount.to_f > 0) ? "#{number_to_indian_currency(current_client.cancellation_amount)} processing charges will be applied on cancellation of booking" : ""
      %>
      <% if current_client.disclaimer.present? %>
        <div class="card card-body small" style="height: 100px; overflow: auto;">
          <div class="font-weight-bold mb-2">Disclaimer:</div>
          <%= current_client.disclaimer %>
        </div>
        <div class="mt-3"></div>
      <% end %>
      <% if @booking_detail_scheme.present? && @booking_detail_scheme.editable_payment_adjustments_present? %>
        <div class="alert alert-danger">
          As the payment is adjusted, this scheme will go for approval first.
        </div>
      <% end %>
      <% if @project_unit.status == "hold" %>
        <% if current_user.buyer? %>
          <%= link_to "I Agree", booking_buyer_booking_detail_path(@booking_detail), method: :patch, class: 'btn btn-primary', style:'margin-top:0px', onclick: alert %>
        <% elsif @user.unattached_blocking_receipt(@project_unit.blocking_amount).present? %>
          <%= link_to "I Agree on behalf of #{@user.name}", booking_admin_user_booking_detail_path(@user,@booking_detail), method: :patch, class: 'btn btn-primary', style:'margin-top:0px', onclick: alert %>
        <% elsif policy([ current_user_role_group, Receipt.new(user: @user, status: "clearance_pending", booking_detail_id: @booking_detail.id)]).new? %>
          <%= link_to "I Agree on behalf of #{@user.name} and proceed to add
          payment",new_admin_user_booking_detail_receipt_path(@user.id, @booking_detail.id) , class: 'btn btn-primary modal-remote-form-link', style:'margin-top:0px', onclick: alert %>
          <% if @booking_detail_scheme.present? && @booking_detail_scheme.editable_payment_adjustments_present? %>
            <%= link_to "Proceed without payment", send_under_negotiation_admin_user_booking_detail_path(@user.id, @booking_detail.id), class: 'btn btn-primary', style:'margin-top:0px', onclick: alert, method: :patch %>
          <% end %>
        <% else %>
          <div class="alert alert-danger">
            You do not have access to take a Clearance pending <%= global_labels[:receipt] %> on behalf of <%= @user.name %>.
          </div>
        <% end %>
        <%= form_for @project_unit, url: make_available_user_search_path(@search), method: 'post', html: {class: 'validate-form'} do |f| %>
          <%= f.hidden_field :status, value: 'available' %>
          <%= f.submit 'Cancel', class: 'btn btn-danger mt-1 mt-md-0' , data:{event_category: 'Section', event_action: 'Click', event_name: 'Cancel'} %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
<!-- GENERICTODO: Ecommerce conversion call ga -->
<%= javascript_tag do %>
  $(document).ready(function(){
    var countdown_time = "<%= (@project_unit.held_on + @project_unit.holding_minutes.minutes).in_time_zone(current_user.time_zone).strftime("%m/%d/%Y %H:%M:%S") %>";
    $("#held-until-countdown").countdown(countdown_time, {
      elapse: false
    }).on('update.countdown', function(event) {
      if (!event.elapsed) {
        $(this).text(event.strftime('%M:%S'));
      }
    }).on('finish.countdown', function(){
      window.location.reload();
    });
    FormInitializer.init($("#update_scheme_booking_detail_form"))
  });
<% end %>
