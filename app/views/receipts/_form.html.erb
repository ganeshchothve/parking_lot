<%
  direct = (defined?(direct) && direct == true) ? true : false
%>
<div class="modal fade right fixed-header-footer" role="dialog" id="modal-remote-form-inner">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><%= @receipt.new_record? ? "New" : "Edit" %> <%= "#{global_labels['receipt']}" %></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <% if @receipt.new_record? %>
          <% if current_user.buyer? && !direct %>
          <div class="alert alert-info">
            <p>
              Payments need to be for individual units, clubbed payments are not allowed. <br/>Please collect a cheque for individual units only.
            </p>
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Unit</label>
                  <div><%= @receipt.project_unit.name %></div>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Agreement Price</label>
                  <div><%= number_to_indian_currency(@receipt.project_unit.agreement_price.round) %></div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Amount Paid</label>
                  <div><%= number_to_indian_currency(@receipt.project_unit.total_amount_paid.round) %></div>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label class="small">Amount Pending</label>
                  <div><%= number_to_indian_currency(@receipt.user.total_balance_pending.round) %></div>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        <% end %>
        <% if current_user.buyer? %>
          <%= form_for @receipt, local: true, remote: true, html: {class: 'modal-remote-form validate-form', "data-resource-type": global_labels['receipt'], "data-type": "json", id: "receipt_form"} do |f| %>
          <div class="form-group">
            <%= f.label :total_amount, class: 'label-required' %>
            <% if current_client.blocking_amount_editable %>
              <%= f.number_field :total_amount, min: 0, max: (@project_unit.present? ? @project_unit.pending_balance : ProjectUnit.blocking_amount), class: "form-field form-control green", required: 'required' %>
            <% else %>
              <h5><%= number_to_indian_currency(ProjectUnit.blocking_amount) %></h5>
              <%= f.hidden_field :total_amount, value: ProjectUnit.blocking_amount %>
            <% end %>
          </div>
          <% if !direct %>
            <%= f.hidden_field :project_unit_id %>
          <% end %>
          <%= f.hidden_field :payment_mode %>
          <%= f.submit "Proceed", class: 'btn btn-primary nav-btn' %>
          <% end %>
        <% else %>
          <% labels = t('mongoid.attributes.receipt').with_indifferent_access %>
          <%= form_for [:admin, @user, @receipt], local: true, remote: true, html: {id: 'receipt_form', class: 'modal-remote-form validate-form', "data-resource-type": global_labels['receipt'], "data-type": "json"} do |f| %>
            <div class="alert alert-warning">
              The <%= labels[:receipt_id] %> will be generated only after successful processing of payment.
            </div>
            <div class="form-group">
              <%= f.label :payment_mode, class: 'label-required' %>
              <%= f.select :payment_mode, Receipt.available_payment_modes.reject{|x| x[:id] == 'online'}.collect{|x| [x[:text], x[:id]]}, {prompt: true}, class: 'selectize', required: 'required', autofocus: true, disabled: (policy(@receipt).editable_field?("payment_mode") ? false : true) %>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <%= f.label :issuing_bank, class: 'label-required' %>
                  <%= f.text_field :issuing_bank, class: 'form-control', required: 'required', disabled: (policy(@receipt).editable_field?("issuing_bank") ? false : true) %>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <%= f.label :issuing_bank_branch, class: 'label-required' %>
                  <%= f.text_field :issuing_bank_branch, class: 'form-control', required: 'required', disabled: (policy(@receipt).editable_field?("issuing_bank_branch") ? false : true) %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <%= f.label :payment_identifier, class: 'label-required' %>
                  <%= f.text_field :payment_identifier, class: 'form-control', required: 'required', disabled: (policy(@receipt).editable_field?("payment_identifier") ? false : true) %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group position-relative">
                  <%= f.label :issued_date, class: 'label-required' %>
                  <%= f.text_field :issued_date, class: 'form-control datepicker', required: 'required', "data-default-date": f.object.issued_date.present? ? f.object.issued_date.strftime("%d/%m/%Y") : '', "data-max-date": Date.tomorrow.strftime("%d/%m/%Y"), disabled: (policy(@receipt).editable_field?("issued_date") ? false : true), value: f.object.issued_date.present? ? f.object.issued_date.strftime("%d/%m/%Y") : "" %>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <%= f.label :status, class: 'control-label' %>
                  <%
                  statuses = Receipt.available_statuses.collect{|x| [x[:text], x[:id]]}
                  if @receipt.status == 'pending'
                    statuses = statuses.reject{|x| x[1] == 'success'}
                  elsif @receipt.status == 'clearance_pending'
                    statuses = statuses.reject{|x| x[1] == 'pending'}
                  end
                  if policy(@receipt).editable_field?("status")
                    statuses = statuses.reject{|x| x[1] == "pending"}
                  end
                  %>
                  <%= f.select :status, statuses, {prompt: true}, class: 'selectize', required: 'required', disabled: (policy(@receipt).editable_field?("status") ? false : true) %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <% if !direct && current_client.enable_actual_inventory %>
                    <% if f.object.project_unit_id.present? %>
                    <%= f.label :project_unit_id, class: 'control-label' %>
                    <div><%= f.object.project_unit.name %></div>
                    <%= f.hidden_field :project_unit_id %>
                    <% else %>
                    <%
                    if params[:reference_project_unit_id].present?
                      f.object.reference_project_unit_id = params[:reference_project_unit_id]
                    end
                    if params[:sfdc_reference_project_unit_id].present?
                      f.object.reference_project_unit_id = ProjectUnit.where(sfdc_id: params[:sfdc_reference_project_unit_id]).first.id
                    end
                    %>
                    <%= f.label :reference_project_unit_id, class: 'control-label' %>
                    <%= f.select :reference_project_unit_id, f.object.reference_project_unit.present? ? [[f.object.reference_project_unit.name, f.object.reference_project_unit.id]] : [], {prompt: true}, class: 'selectize-remote', autofocus: true, disabled: (policy(@receipt).editable_field?("reference_project_unit_id") ? false : true), "data-url": admin_project_units_path, "data-params": {fltrs: {status: 'available'}}.to_json, 'data-ds': 'ds' %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
            <% if (current_user.role?("crm") || current_user.role?("sales") || current_user.role?("cp") || current_user.role?("cp") || current_user.role?("admin")) && @receipt.persisted? && @receipt.status == 'clearance_pending' %>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <%= f.label :tracking_id, class: 'control-label' %>
                    <%= f.text_field :tracking_id, class: 'form-control', required: 'required' %>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <% tomorrow = Date.today+1%>
                    <%= f.label :processed_on, class: 'control-label' %>
                    <%= f.text_field :processed_on, class: 'form-control datepicker', required: 'required', "data-default-date": f.object.processed_on.present? ? f.object.processed_on.strftime("%d/%m/%Y") : '', "data-max-date": tomorrow.strftime("%d/%m/%Y"), value: f.object.processed_on.present? ? f.object.processed_on.strftime("%d/%m/%Y") : "" %>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <%= f.label :comments, class: 'control-label' %>
                <%= f.text_area :comments, class: 'form-control' %>
              </div>
            <% end %>
            <div class="form-group">
              <%= f.label :total_amount, class: 'label-required' %>
              <% if current_client.blocking_amount_editable %>
                <%= f.number_field :total_amount, min: 0, class: "form-field form-control green", required: 'required', disabled: (policy(@receipt).editable_field?("total_amount") ? false : true) %>
              <% else %>
                <h5><%= number_to_indian_currency(ProjectUnit.blocking_amount) %></h5>
                <%= f.hidden_field :total_amount, value: ProjectUnit.blocking_amount %>
              <% end %>
              <%= f.hidden_field :payment_type, class: 'form-control', required: 'required', disabled: (policy(@receipt).editable_field?("payment_type") ? false : true) %>
            </div>
            <div class="form-group">
              <%= f.submit "Save", class: 'btn btn-primary' %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<%= javascript_tag do %>
  $(document).ready(function(){
    FormInitializer.init($('#receipt_form'));
  });
<% end %>
