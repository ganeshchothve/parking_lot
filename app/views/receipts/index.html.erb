<%= content_for :breadcrumbs do %>
  <% unless current_user.role?('user') %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="<%= after_sign_in_path_for(current_user) %>">Dashboard</a></li>
      <% if UserPolicy.new(current_user, User).index? %>
        <li class="breadcrumb-item"><a href="<%= admin_users_path %>">Users</a></li>
      <% end %>
      <li class="breadcrumb-item active" aria-current="page"><%= global_labels['receipts'] %></li>
    </ol>
  </nav>
  <% end %>
<% end %>
<% unless current_user.role?('user') %>
  <% unless ReceiptPolicy.new(current_user, Receipt.new(user: @user)).new? %>
    <div class="alert alert-warning">
      You might need to complete the user's KYC before you can take payments.
    </div>
  <% end %>
<% end %>
<table class='table'>
  <thead class="th-default">
    <% labels = t('mongoid.attributes.receipt').with_indifferent_access %>
    <tr>
      <th><%= labels['receipt_id'] %></th>
      <th><%= labels['total_amount'] %></th>
      <th><%= labels['payment_mode'] %></th>
      <th>Details</th>
      <th><%= labels['project_unit_id'] %></th>
      <th><%= labels['status'] %></th>
      <th class="text-right">Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @receipts.each do |receipt| %>
    <tr>
      <td><%= receipt.receipt_id %></td>
      <td><%= receipt.total_amount %></td>
      <td><%= Receipt.available_payment_modes.find{|x| x[:id] == receipt.payment_mode}[:text] %></td>
      <td>
        <% if receipt.payment_mode == 'online' %>
          TODO
          <div class='small'>Transaction ID: <%= receipt.payment_identifier %></div>
        <% else %>
          <div class='small'>Bank: <%= receipt.issuing_bank %></div>
          <div class='small'>Branch: <%= receipt.issuing_bank_branch %></div>
          <div class='small'>Date: <%= receipt.issued_date %></div>
          <div class='small'>ID: <%= receipt.payment_identifier %></div>
        <% end %>
      </td>
      <td><%= receipt.project_unit.present? ? receipt.project_unit.name : '-' %></td>
      <td><%= Receipt.available_statuses.find{|x| x[:id] == receipt.status}[:text] %></td>
      <td class="text-right">
        <div class="dropdown show">
          <a class="btn btn-light dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a>
          <div class="dropdown-menu dropdown-menu-right">
            <% if receipt.status == 'success' %>
              <%= link_to 'Print', receipt_path(receipt), class: 'dropdown-item' %> <!-- TODO: Implement this -->
            <% end %>
            <% if ReceiptPolicy.new(current_user, receipt).edit? %>
              <%= link_to 'Edit', edit_admin_user_receipt_path(receipt.user_id, receipt), class: 'dropdown-item' %> <!-- TODO: Implement this -->
            <% end %>
          </div>
        </div>
      </td>
    </tr>
    <% end %>
  </tbody>
</table>

<% if ReceiptPolicy.new(current_user, Receipt.new(user: @user)).new? %>
  <% unless current_user.role?('user') %>
    <%= link_to "Add #{global_labels['receipt']}", new_admin_user_receipt_path(@user), class: 'btn btn-primary' %>
  <% end %>
<% end %>
