<div class="form-group">
  <% _params = {fltrs: { project_tower: booking_detail.project_unit.project_tower_id, can_be_applied_by: current_user.role, user_role: booking_detail.user.role, user_id: booking_detail.user_id, status: 'approved' } } %>
  <% if booking_detail.user && booking_detail.user.manager_role?('channel_partner') %>
    <% _params[:fltrs].delete :can_be_applied_by %>
    <% _params[:fltrs][:can_be_applied_by_role] = booking_detail.user.manager_role %>
    <% _params[:fltrs][:default_for_user_id] = booking_detail.user.manager_id %>
  <% end %>

  <%= f.label :derived_from_scheme_id, class: 'control-label' %>
  <%= f.select :derived_from_scheme_id, options_from_collection_for_select(Scheme.where(_id: f.object.derived_from_scheme_id), 'id', 'name', f.object.derived_from_scheme_id), {prompt: true }, class: 'selectize-remote', required: 'required', autofocus: true, data: { url: admin_schemes_path, params: _params }%>
</div>
<%= f.hidden_field :booking_detail_id %>
<%= f.hidden_field :project_unit_id %>
<%= f.hidden_field :user_id %>
<div class="non-editable-payment-adjustments">
  <% booking_detail_scheme.non_editable_payment_adjustments.each do |payment_adjustment| %>
  <div class="row">
    <div class="col-md-4">
      <p>Name</p>
      <p><%= payment_adjustment.name %></p>
    </div>
    <div class="col-md-4">
      <p>Field</p>
      <p><%= payment_adjustment.field %></p>
    </div>
    <div class="col-md-4">
      <p>Value</p>
      <p><%= payment_adjustment.value(booking_detail.project_unit) %></p>
    </div>
  </div>
  <% end %>
</div>
<% editable_payment_adjustment = policy([ current_user_role_group, booking_detail_scheme]).editable_field?("payment_adjustments_attributes") %>
<div class="payment-adjustments">
  <%= f.fields_for :payment_adjustments, booking_detail_scheme.editable_payment_adjustments do |adj| %>
    <% if editable_payment_adjustment %>
      <%= adj.link_to_remove icon("far", "times-circle") %>
    <% end %>
    <%= adj.hidden_field :editable, value: true %>
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <%= adj.label :name, class: 'label-required' %>
          <%= adj.text_field :name, class: "form-control", required: 'required', disabled: !editable_payment_adjustment %>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <%= adj.label :field, class: 'label-required' %>
          <%= adj.select :field, Scheme.available_fields.collect{|x| [x.titleize, x]}, {prompt: true}, class: 'selectize-tags', disabled: !editable_payment_adjustment %>
        </div>
      </div>
    </div>
    <div class="form-group">
      <%= adj.label :absolute_value, class: 'label-required' %>
      <%= adj.number_field :absolute_value, class: "form-control", disabled: !editable_payment_adjustment %>
      <p class="small text-muted">Total Adjustment will be calculated as Rs. (saleable) * (scheme mentioned here)</p>
    </div>
    <div class="form-group">
      <%#= adj.label :formula, class: 'label-required' %>
      <%#= adj.text_field :formula, class: "form-control", disabled: !editable_payment_adjustment %>
      <!-- <p class="small text-muted">Total Adjustment will be calculated as Rs. (saleable) * (scheme mentioned here)</p>
    --> </div>
  <% end %>
</div>
<% if editable_payment_adjustment %>
  <%= f.link_to_add "Add Adjustments", :payment_adjustments, :data => { :target => ".payment-adjustments" } %>
<% end %>
</br>
<% if policy([current_user_role_group, booking_detail_scheme]).editable_field?("event") && action_name != 'checkout' %>
  <div class="form-group">
    <%= f.label :status, class: 'label-required' %>
    <%
      events = booking_detail_scheme.aasm.events(permitted: true).collect{|x| x.name.to_s}
      events = events.collect{|x| [x.to_s.titleize, x.to_s] }
    %>
    <%= f.select :event, options_for_select(events, booking_detail_scheme.status), {prompt: true}, class: 'selectize', required: "required" %>
  </div>
<% end %>

<%= javascript_tag do %>
$(document).ready(function(){
  FormInitializer.init($("#scheme_form"));
  var payment_adjustment_html = function(record){
    return '<div class="row">\
      <div class="col-md-4">\
        <p>Name</p>\
        <p>' + record.name + '</p>\
      </div>\
      <div class="col-md-4">\
        <p>Field</p>\
        <p>' + record.field + '</p>\
      </div>\
      <div class="col-md-4">\
        <p>Value</p>\
        <p>' + record.value + '</p>\
      </div>\
    </div>'
  }
  $('[name="booking_detail_scheme[derived_from_scheme_id]"]').change(function(){
    $(".non-editable-payment-adjustments").html("");
    $(".payment-adjustments").html("");
    $.ajax({
      url: "/admin/schemes/" + $(this).val() + "/payment_adjustments_for_unit",
      type: "GET",
      dataType: 'json',
      data: {
        project_unit_id: "<%= booking_detail.project_unit.id %>"
      },
      success: function(data, xhr, status){
        _.each(data, function(record){
          var html = payment_adjustment_html(record);
          $(".non-editable-payment-adjustments").append(html);
        })
      }, error: function(){

      }
    })
  });
});
<% end %>
