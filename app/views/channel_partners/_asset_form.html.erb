<% if policy([ current_user_role_group, Asset.new(assetable: assetable)]).update? %>
  <div class = "new_asset">
    <div class="row mb-4">
      <div class="col-lg-10 col-12">
        <% options = assetable_document_types(assetable, current_client) %>
        <%= select_tag I18n.t("mongoid.models.channel_partners.document_type"), options_for_select(options, options.first[1]), {prompt: I18n.t("global.select"), class: "selectize", required: 'required'} %>
        <div class = "text-muted small pb-2"><%= I18n.t("controller.assets.text.upload_formats_text") %></div>
        <div class = "text-muted small pb-2">
          <%= I18n.t("controller.assets.text.upload_following_docs") %>
          <%= assetable.doc_types&.map { |doc_type|
              t("mongoid.attributes.channel_partner/file_types.#{doc_type}")
            }&.to_sentence
          %>
        </div>
        <div class = "text-muted small"><div class="help_text"></div></div>
      </div>
      <div class="col-lg-2 col-12">
        <div class="mb-3">
          <div class="btn btn-primary fileinput-button pull-right">
            <input type="file" name="files[]" class="btn btn-primary fileupload" data-extensions="<%= allowed_file_extensions('AssetUploader', assetable) %>" data-url="<%= assetables_path(assetable_type: assetable.class.model_name.i18n_key.to_s, assetable_id: assetable.id) %>" multiple=true <%= policy([ current_user_role_group, Asset.new(assetable: assetable)]).update? ? "" : "disabled=disabled" %> data-klass = 'Asset' data-field_name = 'file' data-form-data = '{"document_type": "<%= assetable.class::DOCUMENT_TYPES[0] %>"}' />
          </div>
        </div>
      </div>
    </div>
  </div>
  <%= javascript_tag do %>
    $(document).ready(function(){
      var types = <%= raw t("mongoid.attributes.#{assetable.model_name.element}/file_types").to_json %>
      var helpText = <%= raw t("mongoid.attributes.#{assetable.model_name.element}/help_text").to_json %>
      if(!$("[name='document_type'].selectize").next('.selectize-control').last().hasClass("selectize-dropdown")){
        $(".fileupload").last().fileUploader({
          download_all: false
        });
      }
      var currentType = $('[name="document_type"].selectize').val();
      $('[name="document_type"].selectize').on("change", function(){
        var formData = {"document_type": $(this).val()}
        $(this).closest('.new_asset').find(".fileupload").data('form-data', formData)
        currentType = $(this).val();
        $('.help_text').html("<%= I18n.t('controller.assets.text.valid_documents_for') %> <b>" + types[currentType] + "</b> - </br>" + helpText[currentType + "_html"])
      }).trigger('change');
      $('.fileupload').on("click", function(){
        if($('.' + currentType).length == 0){
          var html_content = "<div class = 'card m-2'><div class = 'card-header'>" + types[currentType] +"</div><div class = 'car-body'><div class = 'files-container p-3 "+ currentType + "'></div></div></div>"
          $(".assets").prepend(html_content)
        }
        var target = $('.' + currentType)
        $('.fileupload').last().data('target', target)
      })
    });
  <% end %>
<% end %>
<div class = "assets">
  <% @assets = assetable.assets.where(document_type: { '$ne': nil}) %>
  <% unless @assets.count.zero? %>
    <% @assets.group_by(&:document_type).each do |key, value| %>
      <div class="card m-2">
        <div class = 'card-header'>
            <%= t("mongoid.attributes.#{assetable.model_name.element}/file_types.#{key}") %>
        </div>
        <div class = 'card-body'>
          <div class = "row">
            <div class="files-container <%= key %>">
              <% value.each do |asset| %>
                <%=
                  links = {}
                  if policy([ current_user_role_group, asset]).destroy?
                    links[:destroy] = assetable_path(assetable_type: assetable.class.model_name.i18n_key.to_s, assetable_id: assetable.id, id: asset.id)
                  end
                  if asset.file.file && asset.file.file.exists?
                    render "assets/file_icon", record: {id: asset.id, file_size: asset.file_size, url: asset.file.url, content_type: asset.file.content_type, name: asset.file_name }, links: links
                  end
                %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
