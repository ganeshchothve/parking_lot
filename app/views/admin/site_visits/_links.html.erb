<% if policy([:admin, site_visit]).show? %>
  <%= link_to t('controller.site_visits.show.link_name'), admin_site_visit_path(site_visit.id), class: "dropdown-item" %>
<% end %>
<% if policy([:admin, site_visit]).sync_with_selldo? %>
  <%= link_to t('controller.site_visits.sync_with_selldo.link_name'), sync_with_selldo_admin_site_visit_path(site_visit.id), class: "dropdown-item" %>
<% end %>
<% if policy([:admin, Receipt.new(user: site_visit.lead.user, lead: site_visit.lead)]).new? %>
  <%= link_to t('controller.receipts.new.link_name'), new_admin_lead_receipt_path(site_visit.lead), class: "dropdown-item modal-remote-form-link" %>
<% end %>
<% if allow_reschedule?(site_visit) %>
  <%= link_to t('controller.site_visits.edit.link_name'), edit_admin_site_visit_path(site_visit.id), class: "dropdown-item modal-remote-form-link" %>
<% end %>
<% if allow_state_change?(site_visit) %>
  <% site_visit.aasm(:status).events(permitted: true).each do |event| %>
    <%= link_to t("controller.site_visits.events.status.#{event.name}"), change_state_admin_site_visit_path(site_visit, {site_visit: {event: event.name}}), method: :patch, class: 'dropdown-item' %>
  <% end %>
<% end %>
<% if allow_approval_state_change?(site_visit) %>
  <% site_visit.aasm(:approval_status).events(permitted: true).each do |event| %>
    <% if event.name.to_s == 'reject' %>
      <%= link_to t("controller.site_visits.events.approval_status.#{event.name}"), reject_admin_site_visit_path(site_visit), class: 'dropdown-item modal-remote-form-link' %>
    <% elsif event.name.to_s != 'pending' %>
      <%= link_to t("controller.site_visits.events.approval_status.#{event.name}"), change_state_admin_site_visit_path(site_visit, {site_visit: {approval_event: event.name}}), method: :patch, class: 'dropdown-item' %>
    <% end %>
  <% end %>
<% end %>
<% if ['channel_partner', 'cp_owner', 'dev_sourcing_manager', 'sales', 'admin'].include?(current_user.role) %>
  <% if policy([:admin, BookingDetail.new(user: site_visit.lead.user, lead: site_visit.lead, project_unit: ProjectUnit.new(status: 'available', blocking_amount: current_client.blocking_amount))]).show_booking_link?(current_project.try(:id).try(:to_s)) %>
    <%= link_to t('controller.searches.new.link_name'), new_admin_lead_search_path(lead_id: site_visit.lead.id, site_visit_id: site_visit.id), class: "dropdown-item" %>
  <% end %>
<% end %>
<% if policy([:admin, BookingDetail.new(user: site_visit.lead.user, lead: site_visit.lead)]).show_add_booking_link?(current_project.try(:id).try(:to_s)) %>
  <%= link_to "Add Booking", new_booking_without_inventory_admin_booking_details_path(lead_id: site_visit.lead.id, site_visit_id: site_visit.id), class: "dropdown-item modal-remote-form-link" %>
<% end %>

<%= render 'admin/invoices/invoiceable_links', resource: site_visit %>

<% if allow_add_notes?(site_visit) %>
  <%= link_to t('helpers.new.link_name', model: Note.model_name.human), new_notable_path(notable_type: site_visit.class.model_name.i18n_key.to_s, notable_id: site_visit.id), class: "dropdown-item modal-remote-form-link" %>
<% end %>

