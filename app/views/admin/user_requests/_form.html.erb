<%
  hash = {"data-resource-type": global_labels['user_request'], "data-type": "json"}
  hash = {confirm: 'Are you sure you want to proceed?'} if @user_request.new_record? && current_user.buyer?
%>
<%
  url = if current_user.buyer?
    if @user_request.new_record?
      user_user_requests_path(request_type: @user_request.class.model_name.element)
    else
      user_user_request_path(request_type: @user_request.class.model_name.element, id: @user_request.id)
    end
  else
    if @user_request.new_record?
      admin_user_user_requests_path(user_id: @user_request.user_id, request_type: @user_request.class.model_name.element)
    else
      admin_user_user_request_path(user_id: @user_request.user_id, request_type: @user_request.class.model_name.element, id: @user_request.id)
    end
  end
%>
<%= form_for @user_request, url: url, remote: true, html: {class: 'modal-remote-form validate-form', "data-resource-type": global_labels['user_requests'], "data-type": "json"}, data: hash do |f| %>
<div class="modal fade right fixed-header-footer" role="dialog" id="modal-remote-form-inner">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><%= @user_request.new_record? ? "New" : "Edit" %> <%= "#{global_labels['user_request']}" %></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <% if policy(@user_request).editable_field?("project_unit_id") %>
          <div class="form-group">
            <%= f.label :project_unit_id, class: 'label-required' %>
            <%= f.select :project_unit_id, @user_request.user.project_units.in(status: ProjectUnit.booking_stages).collect{|x| [x.name, x.id] }, {prompt: true}, class: 'selectize', disabled: (policy(@user_request).editable_field?("project_unit_id") ? false : true), required: "required" %>
          </div>
        <% else %>
          <div class="form-group">
            <%= f.label :project_unit_id, class: 'label-required' %>
            <div><%= @user_request.project_unit.name %></div>
          </div>
        <% end %>
        <% begin %>
          <%= render "admin/user_requests/#{@user_request.class.model_name.element}", f: f %>
          <hr/>
        <% rescue ActionView::MissingTemplate %>
        <% end %>

        <div class="form-group">
          <%= f.label :status, class: 'label-required' %>
          <% if policy(@user_request).editable_field?("status") %>
            <%= f.select :status, UserRequest.available_statuses.reject{|x| x[:id] == "failed"}.collect{|x| [x[:text], x[:id]]}, {prompt: true}, class: 'selectize', required: "required" %>
          <% else %>
            <h6><%= f.object.class.available_statuses.find{|x| x[:id] == f.object.status}[:text] %></h6>
          <% end %>
        </div>
        <% if @user_request.status == "failed" %>
          <div class="form-group">
            <%= f.label :reason_for_failure, class: 'label-required' %>
            <div><%= @user_request.reason_for_failure %></div>
          </div>
        <% end %>
        <% if policy(@user_request).editable_field?("notes_attributes") %>
          <% f.object.notes.new(creator_id: current_user.id) %>
          <%= f.fields_for :notes do |note_field|%>
            <% if (note_field.object.new_record? && policy(note_field.object).create?) || policy(note_field.object).edit? %>
              <div class="form-group">
                <%= note_field.label :comments %>
                <%= note_field.text_area :note, autofocus: true, class: "form-control" %>
                <% if note_field.object.creator.role == "user" %>
                  <%= note_field.hidden_field :note_type, value: (note_field.object.note_type.present? ? note_field.object.note_type : "user") %>
                <% else %>
                  <%#= note_field.select :note_type, Note.available_note_types.collect{|x| [x[:text], x[:id]] }, {prompt: true}, class: 'textr-right mt-2 form-control-sm' %>
                <% end %>
                <%= note_field.hidden_field :creator_id %>
              </div>
            <% else %>
              <div>
                <%= note_field.hidden_field :creator_id %>
                <%= note_field.hidden_field :note %>
                <%= note_field.hidden_field :note_type %>
                <div><%= note_field.object.note %></div>
                <small class="text-muted">
                  created by <%= note_field.object.creator.name %> on <%= l(note_field.object.created_at.present? ? note_field.object.created_at.in_time_zone(current_user.time_zone) : Time.now.in_time_zone(current_user.time_zone)) %>
                </small>
              </div>
              <hr/>
            <% end %>
          <% end %>
        <% end %>
        <% if @user_request.new_record? && @user_request.is_a?(UserRequest::Cancellation) %>
          <div class="form-group">
            <div class="alert alert-primary">
              Your unit will be released once the cancellation request is processed. For booking the same unit again, you will have to go through the selection process again which will also be subject to availability.<br/>
              <div class="form-check mt-3">
                <input type="checkbox" id="accepted" class="form-check-input" />
                <label class="form-check-label">I Agree <%= @user_request.user_id == current_user.id ? "" : " on behalf of #{@user_request.user.name}" %></label>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div class="modal-footer">
        <%= f.submit "Submit", class: 'btn btn-primary', disabled: ((@user_request.new_record? && @user_request.is_a?(UserRequest::Cancellation)) ? true : false), id: "submit_request", data:{event_category: 'Section', event_action: 'Click', event_name: 'cancel booking - submit'}  %>
      </div>
    </div>
  </div>
</div>
<% end %>
<%= javascript_tag do %>
$(document).ready(function(){
  FormInitializer.init($('.validate-form'));
  $("#accepted").change(function(){
    if($(this).is(":checked")){
      $("#submit_request").removeAttr("disabled");
    }else{
      $("#submit_request").attr("disabled", "disabled");
    }
  })
});
<% end %>
