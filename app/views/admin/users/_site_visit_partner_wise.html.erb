<!-- TO-DO - Add sourcing manager directory and move this there in dashboard views -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 mt-3 mb-5">
  <div class="box-card relative table-responsive">
    <table class="table my-customer-table responsive-tbl caption-top rounded mt-3 mb-0">
      <thead class="th-default">
        <tr class="bg-primary white">
          <th><%= ChannelPartner.model_name.human(count: 1) %></th>
          <th><%= t("mongoid.attributes.user/role.channel_partner") %></th>
          <th>All<br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t('mongoid.attributes.site_visit/status.scheduled') %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t('mongoid.attributes.site_visit/status.conducted') %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t('mongoid.attributes.site_visit/status.paid') %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t('mongoid.attributes.site_visit/approval_status.approved') %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= BookingDetail.model_name.human(count: 2) %></th>
        </tr>
      </thead>
      <tbody>
        <% user = params[:channel_partner_id].present? ? ChannelPartner.where(id: params[:channel_partner_id]).first&.users&.cp_owner&.first : current_user %>
        <% User.filter_by_role(%w(cp_owner)).where(User.user_based_scope(user || current_user)).limit(15).each do |p| %>
          <% users = User.where(channel_partner_id: p.channel_partner_id) %>
          <tr>
            <td data-title='<%= t("mongoid.attributes.user/role.channel_partner") %>'><%= p.channel_partner.name.titleize %></td>
            <td></td>
            <td data-title='All <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @all_site_visits.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_site_visits_path(fltrs: {channel_partner_id: p.channel_partner.id, scheduled_on: params[:dates], project_id: params[:project_id]}) %></td>
            <td data-title='Scheduled <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @scheduled_site_visits.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_site_visits_path(fltrs: {status: 'scheduled', channel_partner_id: p.channel_partner.id, scheduled_on: params[:dates], project_id: params[:project_id]}) %></td>
            <td data-title='Conducted <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @conducted_site_visits.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_site_visits_path(fltrs: {status: 'conducted', channel_partner_id: p.channel_partner.id, scheduled_on: params[:dates], project_id: params[:project_id]}) %></td>
            <td data-title='Paid <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @paid_site_visits.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_site_visits_path(fltrs: {status: 'paid', channel_partner_id: p.channel_partner.id, scheduled_on: params[:dates], project_id: params[:project_id]}) %></td>
            <td data-title='Approved <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @approved_site_visits.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_site_visits_path(fltrs: {approval_status: 'approved', channel_partner_id: p.channel_partner.id, scheduled_on: params[:dates], project_id: params[:project_id]}) %></td>
            <td data-title='<%= BookingDetail.model_name.human(count: 2) %>'><%= link_to @bookings.values_at(*users.pluck(:id))&.flatten&.compact&.count || 0, admin_booking_details_path(fltrs: {channel_partner_id: p.channel_partner.id, created_at: params[:dates], project_id: params[:project_id]}) %></td>
          </tr>
          <tr>
            <td></td>
            <td data-title='<%= t("mongoid.attributes.user/role.channel_partner") %>'><%= p.name.titleize %></td>
            <td data-title='All <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @all_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {manager_id: p.id, scheduled_on: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
            <td data-title='Scheduled <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @scheduled_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {status: 'scheduled', manager_id: p.id, scheduled_on: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
            <td data-title='Conducted <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @conducted_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {status: 'conducted', manager_id: p.id, scheduled_on: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
            <td data-title='Paid <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @paid_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {approval_status: 'paid', manager_id: p.id, scheduled_on: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
            <td data-title='Approved <%= SiteVisit.model_name.human(count: 2) %>'><%= link_to @approved_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {approval_status: 'approved', manager_id: p.id, scheduled_on: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
            <td data-title='<%= BookingDetail.model_name.human(count: 2) %>'><%= link_to @bookings[p.id].try(:count) || 0, admin_booking_details_path(fltrs: {manager_id: p.id, created_at: params[:dates], project_id: params[:project_id], channel_partner_id: p.channel_partner.id}) %></td>
          </tr>
          <%= render 'channel_partner_site_visits', users: users %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
