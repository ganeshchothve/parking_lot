<!-- TO-DO - Add sourcing manager directory and move this there in dashboard views -->
<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 mt-3 mb-5">
  <div class="box-card relative table-responsive">
    <table class="table my-customer-table responsive-tbl caption-top rounded mt-3 mb-0">
      <thead class="th-default">
        <tr class="bg-primary white">
          <th><%= t("mongoid.attributes.user/role.channel_partner") %> /<br> <%= t("mongoid.attributes.user/role.cp_owner") %></th>
          <th><%= I18n.t("global.link_to.sign_in_count") %></th>
          <% if policy([:admin, Lead]).index? %>
            <th><%= Lead.model_name.human(count: 2) %></th>
          <% end %>
          <th><%= t("mongoid.attributes.site_visit/status.scheduled") %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t("mongoid.attributes.site_visit/status.conducted") %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t("mongoid.attributes.site_visit/status.pending") %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t("mongoid.attributes.site_visit/approval_status.approved") %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= t("mongoid.attributes.site_visit/approval_status.rejected") %><br> <%= SiteVisit.model_name.human(count: 2) %></th>
          <th><%= BookingDetail.model_name.human(count: 2) %></th>
          <th><%= I18n.t("global.total") %><br> <%= t("mongoid.attributes.booking_detail.agreement_price") %></th>
        </tr>
      </thead>
      <tbody>
        <% user = params[:channel_partner_id].present? ? ChannelPartner.where(booking_portal_client_id: current_client.try(:id), id: params[:channel_partner_id]).first&.users&.cp_owner&.first : current_user %>
        <% total_sign_in_count = 0 %>
        <% User.filter_by_role(%w(cp_owner channel_partner)).where(User.user_based_scope(user || current_user)).in(@manager_ids_criteria).limit(15).each do |p| %>
          <% total_sign_in_count += (p.sign_in_count || 0) %>
          <tr>
            <td data-title='<%= t("mongoid.attributes.user/role.channel_partner") %>'><%= p.name.titleize %></td>
            <td data-title=' <%=I18n.t("global.link_to.sign_in_count") %>'><%= p.sign_in_count || 0 %></td>
            <% if policy([:admin, Lead]).index? %>
              <td data-title='<%= Lead.model_name.human(count: 2) %>'><%= link_to @leads[p.id].try(:count) ? @leads[p.id].try(:count) : 0, admin_leads_path(fltrs: {manager_id: p.id, created_at: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <% end %>
            <td data-title='<%= t("mongoid.attributes.site_visit/status.scheduled") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @scheduled_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {status: 'scheduled', manager_id: p.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <td data-title='<%= t("mongoid.attributes.site_visit/status.conducted") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @conducted_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {status: 'conducted', manager_id: p.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <td data-title='<%= t("mongoid.attributes.site_visit/status.pending") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @pending_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {approval_status: 'pending', manager_id: p.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <td data-title='<%= t("mongoid.attributes.site_visit/status.approved") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @approved_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {approval_status: 'approved', manager_id: p.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <td data-title='<%= t("mongoid.attributes.site_visit/status.rejected") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @rejected_site_visits[p.id].try(:count) || 0, admin_site_visits_path(fltrs: {approval_status: 'rejected', manager_id: p.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <td data-title='<%= BookingDetail.model_name.human(count: 2) %>'><%= link_to @bookings[p.id].try(:count) ? @bookings[p.id].try(:count) : 0, admin_booking_details_path(fltrs: {manager_id: p.id, created_at: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
            <% sum_of_av = (@bookings[p.id].try(:pluck, :agreement_price)&.map(&:to_f)&.sum || 0) %>
            <td class='non-action-td' data-title='<%= t("mongoid.attributes.booking_detail.agreement_price") %>'><%= number_to_indian_currency(sum_of_av) %>(<%= number_to_inr(sum_of_av, {precision: 2, significant: false}) %>)</td>
          </tr>
        <% end %>
        <% channel_partner = params[:channel_partner_id].present? ? ChannelPartner.where(booking_portal_client_id: current_client.try(:id), id: params[:channel_partner_id]).first : current_user %>
        <% manager_ids = @manager_ids_criteria.values.flatten %>
        <tr >
          <th data-title='<%= I18n.t("global.total") %>'><%= t("global.total") %></th>
          <th data-title='<%= I18n.t("global.link_to.sign_in_count") %>'><%= total_sign_in_count %></th>
          <% if policy([:admin, Lead]).index? %>
            <td data-title='<%= Lead.model_name.human(count: 2) %>'><%= link_to @leads.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_leads_path(fltrs: {channel_partner_id: channel_partner.id, created_at: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <% end %>
          <td data-title='<%= t("mongoid.attributes.site_visit/status.scheduled") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @scheduled_site_visits.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_site_visits_path(fltrs: {status: 'scheduled', channel_partner_id: channel_partner.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <td data-title='<%= t("mongoid.attributes.site_visit/status.conducted") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @conducted_site_visits.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_site_visits_path(fltrs: {status: 'conducted', channel_partner_id: channel_partner.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <td data-title='<%= t("mongoid.attributes.site_visit/status.pending") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @pending_site_visits.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_site_visits_path(fltrs: {approval_status: 'pending', channel_partner_id: channel_partner.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <td data-title='<%= t("mongoid.attributes.site_visit/status.approved") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @approved_site_visits.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_site_visits_path(fltrs: {approval_status: 'approved', channel_partner_id: channel_partner.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <td data-title='<%= t("mongoid.attributes.site_visit/status.rejected") + " " + SiteVisit.model_name.human(count: 2) %>'><%= link_to @rejected_site_visits.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_site_visits_path(fltrs: {approval_status: 'rejected', channel_partner_id: channel_partner.id, scheduled_on: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <td data-title='<%= BookingDetail.model_name.human(count: 2) %>'><%= link_to @bookings.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.count || 0, admin_booking_details_path(fltrs: {channel_partner_id: channel_partner.id, created_at: @dates, project_id: params[:project_id], channel_partner_id: params[:channel_partner_id]}) %></td>
          <% sum_of_av = (@bookings.select{ |manager_id, leads_data| manager_ids.include?(manager_id) }.values&.flatten&.pluck(:agreement_price)&.map(&:to_f)&.sum || 0) %>
          <td class='non-action-td' data-title='<%= t("mongoid.attributes.booking_detail.agreement_price") %>'><%= number_to_indian_currency(sum_of_av) %>(<%= number_to_inr(sum_of_av, {precision: 2, significant: false}) %>)</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
