<div class="row">
  <div class="col-12">
    <p>Total Users : <%= users.count %></p>
  </div>
</div>
<table class='table striped-table'>
  <thead class="th-default th-pink">
    <% labels = t('mongoid.attributes.user').with_indifferent_access %>
    <tr>
      <th>Name</th>
      <th>Details</th>
      <th>Role</th>
      <th>Account Confirmed?</th>
    </tr>
  </thead>
  <tbody>
    <% users.each do |user| %>
      <tr>
        <td>
          <%= user.name %><br/>
          <% if user.role?("channel_partner") %>
            Registered: <%= User.where(channel_partner_id: user.id).count %> | Confirmed: <%= User.where(channel_partner_id: user.id).ne(confirmed_at: nil).count %> | Blocked: <%= ProjectUnit.in(user_id: User.where(channel_partner_id: user.id).distinct(:id)).in(status: ['blocked', 'booked_tentative', 'booked_confirmed']).count %><br/>
          <% end %>
          <% if UserPolicy.new(current_user, user).show? %>
            <%= link_to "View", admin_user_path(user.id) %> |
            <%= link_to "Add #{global_labels['user_kyc_details']}", new_admin_user_user_kyc_path(user), class: 'blue-link', data:{event_category: 'Section', event_action: 'Click', event_name: 'Add User KYC Co Applicant'} %> |
            <% if !user.confirmed? && user.confirmation_token.present? %>
              <%= link_to 'Resend Confirmation Instructions', resend_confirmation_instructions_admin_user_path(user), class: 'blue-link', data: {event_category: 'Section', event_action: 'Click', event_name: 'Resend Confirmation Instructions'} %>
            <% else %>
              <%= link_to 'Send Password Reset Instructions', resend_password_instructions_admin_user_path(user), class: 'blue-link', data: {event_category: 'Section', event_action: 'Click', event_name: 'Reset Password Instructions'} %>
            <% end %>
          <% end %>
          <% if ['crm', 'sales', 'cp', 'admin'].include?(current_user.role) %>
            <% if UserPolicy.new(current_user, user).edit? %>
              | <%= link_to "Edit", edit_admin_user_path(user.id) %>
            <% end %>
          <% end %>
        </td>
        <td>
          <i class="far fa-envelope"></i> <%= user.email %> <br/>
          <i class="fas fa-mobile-alt"></i><%= user.phone %><br/>
          <% if user.role?("user") && user.channel_partner_id.present? %>
            CP: <%= user.channel_partner.name %><br/>
          <% end %>
        </td>
        <td><%= User.available_roles.find{|x| x[:id] == user.role}[:text] %></td>
        <td><%= user.confirmed_at.present? ? "Confirmed" : "Not confirmed" %></td>
      </tr>
    <% end %>
  </tbody>
</table>
<%= will_paginate users %>
