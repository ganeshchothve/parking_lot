<% labels = t('mongoid.attributes.user').with_indifferent_access %>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-12">
      <%= render 'breadcrumbs', {user: @user} %>
      <div class="card">
        <div class="card-header">
          Overview
          <ul class="nav float-right">
            <% if ['crm', 'sales', 'cp', 'admin'].include?(current_user.role) %>
              <% if UserPolicy.new(current_user, @user).edit? %>
                <li class="nav-item">
                  <%= link_to "Edit", edit_admin_user_path(@user.id), class: 'modal-remote-form-link nav-link'  %>
                </li>
              <% end %>
            <% end %>
            <% if ProjectUnitPolicy.new(current_user, ProjectUnit.new(user: @user, status: "available")).hold? %>
              <li class="nav-item">
                <%= link_to "Take a Booking", new_admin_user_search_path(@user.id), class: "nav-link" %>
              </li>
            <% end %>
            <% if ReceiptPolicy.new(current_user, Receipt).index?(@user) %>
            <li class="nav-item">
              <%= link_to "View #{global_labels['receipts']}", admin_user_receipts_path(user_id: @user.id), class: "nav-link" %>
            </li>
            <% end %>
            <% if @user.present? && !current_user.buyer? && ReceiptPolicy.new(current_user, Receipt.new(user: @user)).new? %>
            <%
                url_for_new_receipt = if @project_unit.present?
                direct_admin_user_project_unit_receipt_path(@user, @project_unit)
              else
                direct_admin_user_receipts_path(@user)
              end
            %>
            <%= link_to "Add #{global_labels['receipt']}", url_for_new_receipt, class: 'nav-link modal-remote-form-link' %>
            <% end %>
            <% if UserKycPolicy.new(current_user, UserKyc).index?(@user) %>
              <li class="nav-item">
                <%= link_to "View #{global_labels['user_kycs']}", admin_user_user_kycs_path(user_id: @user.id), class: "nav-link" %>
              </li>
            <% end %>
          </ul>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:name] %></label>
                <div>
                  <%= @user.name.present? ? @user.name : '-' %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:email] %></label>
                <div>
                  <%= @user.email.present? ? @user.email : '-' %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:phone] %></label>
                <div>
                  <%= @user.phone.present? ? @user.phone : '-' %>
                </div>
              </div>
            </div>
          </div>
          <% if @user.buyer? && current_client.enable_actual_inventory? %>
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:total_amount_paid] %></label>
                <div>
                  <%= @user.total_amount_paid.present? ? number_to_indian_currency(@user.total_amount_paid.round(2)) : '-' %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:total_balance_pending] %></label>
                <div>
                  <%= @user.total_balance_pending.present? ? number_to_indian_currency(@user.total_balance_pending.round(2)) : '-' %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:total_unattached_balance] %></label>
                <div>
                  <%= @user.total_unattached_balance.present? ? number_to_indian_currency(@user.total_unattached_balance.round(2)) : '-' %>
                </div>
              </div>
            </div>
          </div>
          <% end %>
          <div class="row">
            <div class="col-md-4">
              <% if @user.buyer? && current_user.role != "channel_partner" %>
              <div class="form-group">
                <label>Channel Partner</label>
                <div>
                  <% channel_partner_user = @user.channel_partner_id.present? ? User.find(@user.channel_partner_id) : nil %>
                  <%= channel_partner_user.present? ? link_to(channel_partner_user.name, admin_user_path(channel_partner_user)) : '-' %>
                </div>
              </div>
              <% end %>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>Account Confirmed?</label>
                <div>
                  <%= @user.confirmed? ? "At #{l(@user.confirmed_at)}" : "No" %>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label>Last Signed In</label>
                <div>
                  <%= @user.sign_in_count > 0 ? "#{l(@user.last_sign_in_at)} (Signed In #{@user.sign_in_count} times)" : "Never Signed In" %>
                </div>
              </div>
            </div>
          </div>
          <% if @user.role?('channel_partner') %>
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="form-group">
                <label><%= labels[:rera_id] %></label>
                <div>
                  <%= @user.rera_id.present? ? @user.rera_id : '-' %>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>
      <% if @user.role == "channel_partner" %>
        <div class="mt-3"></div>
        <div class="card">
          <div class="card-body">
            <%= render "admin/users/index", users: User.where(channel_partner_id: @user.id).paginate(page: 1, per_page: 100) %>
          </div>
        </div>
      <% end %>
      <% if @user.buyer? && current_client.enable_actual_inventory? %>
        <div class="mt-3"></div>
        <div class="card">
          <div class="card-body">
            <%= render 'admin/project_units/index', {project_units: @project_units} %>
          </div>
        </div>
      <% end %>
      <div class="mt-3"></div>
      <div class="card">
        <div class="card-body">
          <%= render 'receipts/index', {receipts: @receipts} %>
        </div>
      </div>
    </div>
  </div>
</div>
