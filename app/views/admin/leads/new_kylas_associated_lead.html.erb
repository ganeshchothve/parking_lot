<%= form_for(@lead, url: create_kylas_associated_lead_admin_leads_path, local: true, html: {class: 'validate-form mr-3 ml-3', id: 'kylas_lead_form'}) do |f| %>
  <%= render 'kylas_associated_lead_form', f: f %>
<% end %>

<%= javascript_tag do %>
  $(document).ready(function(selector){
    FormInitializer.init($("#kylas_lead_form"));
    var selected_email = $(selector).find(".email_select");
    var emails = selected_email[0].selectize;
    var selected_phones = $(selector).find(".phone_select");
    var phones = selected_phones[0].selectize;
    $('#lead_kylas_contact_id').change(function(e){
      var contactId = $(e.currentTarget).val();
      $.ajax({
        url: "/admin/leads/deal_associated_contact_details.json",
        data: { contact_id: contactId },
        type: "get",
        dataType: "json",
        success: function(data){
          $('#lead_first_name').val(data.firstName);
          $('#lead_last_name').val(data.lastName);
          emails.setValue('');
          emails.clearOptions();
          phones.setValue('');
          phones.clearOptions();
          email_options = _.map(data['emails'], function(d) { return { value: d.value, text: d.value } });
          phone_options = _.map(data['phoneNumbers'], function(d) { return { value: (d.dialCode+d.value), text: (d.dialCode+d.value) } });
          emails.addOption(email_options);
          emails.refreshOptions(false);
          phones.addOption(phone_options);
          phones.refreshOptions(false);
        },
        error: function(){
          Amura.global_error_handler("Internal server error...")
        }
      });
    });

  });
<% end %>